name: Deploy Backend to VPS

on:
  push:
    branches: [main]
    paths:
      - "backend/**"
      - ".github/workflows/deploy-backend-vps.yml"
  workflow_dispatch:

concurrency:
  group: deploy-backend-vps
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy backend on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script_stop: true
          script: |
            set -euo pipefail

            VPS_APP_DIR="${{ vars.VPS_APP_DIR }}"
            DEPLOY_BRANCH="${{ vars.DEPLOY_BRANCH }}"
            PROCESS_MANAGER="${{ vars.PROCESS_MANAGER }}"
            PM2_APP_NAME="${{ vars.PM2_APP_NAME }}"
            SYSTEMD_SERVICE="${{ vars.SYSTEMD_SERVICE }}"
            INSTALL_PLAYWRIGHT="${{ vars.INSTALL_PLAYWRIGHT }}"
            BACKEND_ENV_B64='${{ secrets.BACKEND_ENV_B64 }}'

            VPS_APP_DIR="${VPS_APP_DIR:-/var/www/alhamdulillah_ai_sass_personalized_email_writer}"
            DEPLOY_BRANCH="${DEPLOY_BRANCH:-main}"
            PROCESS_MANAGER="${PROCESS_MANAGER:-pm2}"
            INSTALL_PLAYWRIGHT="${INSTALL_PLAYWRIGHT:-0}"

            if [ ! -d "$VPS_APP_DIR/.git" ]; then
              echo "ERROR: VPS_APP_DIR does not look like a git repo: $VPS_APP_DIR" >&2
              exit 1
            fi

            cd "$VPS_APP_DIR"
            git fetch origin "$DEPLOY_BRANCH"
            git checkout "$DEPLOY_BRANCH"
            git reset --hard "origin/$DEPLOY_BRANCH"

            cd backend

            if [ -n "$BACKEND_ENV_B64" ]; then
              umask 077
              printf '%s' "$BACKEND_ENV_B64" | base64 -d > .env
            fi

            npm ci --omit=dev

            if [ "$INSTALL_PLAYWRIGHT" = "1" ]; then
              npx playwright install --with-deps chromium
            fi

            if [ "$PROCESS_MANAGER" = "systemd" ]; then
              if [ -z "$SYSTEMD_SERVICE" ]; then
                echo "ERROR: SYSTEMD_SERVICE is required when PROCESS_MANAGER=systemd" >&2
                exit 1
              fi
              sudo systemctl restart "$SYSTEMD_SERVICE"
              sudo systemctl status "$SYSTEMD_SERVICE" --no-pager -l || true
            else
              if [ -z "$PM2_APP_NAME" ]; then
                echo "ERROR: PM2_APP_NAME is required when PROCESS_MANAGER=pm2" >&2
                exit 1
              fi
              if pm2 describe "$PM2_APP_NAME" >/dev/null 2>&1; then
                pm2 reload "$PM2_APP_NAME" --update-env
              else
                pm2 start npm --name "$PM2_APP_NAME" -- start
              fi
              pm2 save
              pm2 status
            fi

            echo "Deploy complete."
