name: Deploy Backend to VPS

on:
  push:
    branches: [main]
    paths:
      - "backend/**"
      - ".github/workflows/deploy-backend-vps.yml"
  workflow_dispatch:

concurrency:
  group: deploy-backend-vps
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate deploy secrets
        shell: bash
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
        run: |
          set -euo pipefail
          : "${VPS_HOST:?Missing VPS_HOST secret}"
          : "${VPS_USER:?Missing VPS_USER secret}"
          : "${VPS_SSH_KEY:?Missing VPS_SSH_KEY secret (must be the PRIVATE key)}"
          VPS_PORT="${VPS_PORT:-22}"
          echo "Deploy target: $VPS_USER@$VPS_HOST:$VPS_PORT"

      # Optional: keep this while you validate SSH from Actions; remove later if you want faster runs.
      - name: SSH auth preflight (debug)
        shell: bash
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
        run: |
          set -euo pipefail
          VPS_PORT="${VPS_PORT:-22}"
          umask 077
          printf '%s' "$VPS_SSH_KEY" | tr -d '\r' > ./_deploy_key
          chmod 600 ./_deploy_key
          ssh -vv -i ./_deploy_key -p "$VPS_PORT" \
            -o StrictHostKeyChecking=no \
            -o PreferredAuthentications=publickey \
            -o BatchMode=yes \
            -o ConnectTimeout=15 \
            "$VPS_USER@$VPS_HOST" "echo 'ssh ok'"

      - name: Deploy backend on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.VPS_PORT }}
          key: ${{ secrets.VPS_SSH_KEY }}
          debug: true
          script_stop: true
          script: |
            set -euo pipefail

            VPS_APP_DIR="${{ vars.VPS_APP_DIR }}"
            DEPLOY_BRANCH="${{ vars.DEPLOY_BRANCH }}"
            PROCESS_MANAGER="${{ vars.PROCESS_MANAGER }}"
            PM2_APP_NAME="${{ vars.PM2_APP_NAME }}"
            SYSTEMD_SERVICE="${{ vars.SYSTEMD_SERVICE }}"
            INSTALL_PLAYWRIGHT="${{ vars.INSTALL_PLAYWRIGHT }}"
            BACKEND_ENV_B64="${{ secrets.BACKEND_ENV_B64 }}"

            VPS_APP_DIR="${VPS_APP_DIR:-/var/www/alhamdulillah_ai_sass_personalized_email_writer}"
            DEPLOY_BRANCH="${DEPLOY_BRANCH:-main}"
            PROCESS_MANAGER="${PROCESS_MANAGER:-pm2}"
            INSTALL_PLAYWRIGHT="${INSTALL_PLAYWRIGHT:-0}"

            if [ ! -d "$VPS_APP_DIR/.git" ]; then
              echo "ERROR: VPS_APP_DIR does not look like a git repo: $VPS_APP_DIR" >&2
              exit 1
            fi

            cd "$VPS_APP_DIR"
            git fetch origin "$DEPLOY_BRANCH"
            git checkout "$DEPLOY_BRANCH"
            git reset --hard "origin/$DEPLOY_BRANCH"

            cd backend

            if [ -n "$BACKEND_ENV_B64" ]; then
              umask 077
              printf '%s' "$BACKEND_ENV_B64" | base64 -d > .env
            fi

            npm ci --omit=dev

            if [ "$INSTALL_PLAYWRIGHT" = "1" ]; then
              npx playwright install --with-deps chromium
            fi

            if [ "$PROCESS_MANAGER" = "systemd" ]; then
              if [ -z "$SYSTEMD_SERVICE" ]; then
                echo "ERROR: SYSTEMD_SERVICE is required when PROCESS_MANAGER=systemd" >&2
                exit 1
              fi
              sudo systemctl restart "$SYSTEMD_SERVICE"
              sudo systemctl status "$SYSTEMD_SERVICE" --no-pager -l || true
            else
              if [ -z "$PM2_APP_NAME" ]; then
                echo "ERROR: PM2_APP_NAME is required when PROCESS_MANAGER=pm2" >&2
                exit 1
              fi

              if pm2 describe "$PM2_APP_NAME" >/dev/null 2>&1; then
                pm2 reload "$PM2_APP_NAME" --update-env
              else
                pm2 start npm --name "$PM2_APP_NAME" -- start
              fi

              pm2 save
              pm2 status
            fi

            echo "Deploy complete."
